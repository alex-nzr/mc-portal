this.BX=this.BX||{},this.BX.Cbit=this.BX.Cbit||{},this.BX.Cbit.Mc=this.BX.Cbit.Mc||{},function(t,e){"use strict";var i=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};babelHelpers.classCallCheck(this,t),this.moduleId=e.moduleId,this.typeId=e.typeId,this.entityTypeId=e.entityTypeId,this.entityId=e.entityId,this.opportunity=Number(e.opportunity),this.isNew=e.isNew,this.typeOfRequest=e.typeOfRequest,this.splitBtnDatasetId=e.splitBtnDatasetId,this.pullActions=e.pullActions,this.postActionKey=e.postActionKey,this.splitRequestAction=e.splitRequestAction,this.isAdmin=e.isAdmin,this.typeOfRequestNodeId="type_of_request_block",this.submitSplitFormBtnId="split-request-amount-submit-btn",this.submitRejectFormBtnId="reject-request-submit-btn",this.init()}return babelHelpers.createClass(t,[{key:"init",value:function(){this.initEntityDetailManager(),this.initEvents(),this.initButtons()}},{key:"initEntityDetailManager",value:function(){this.entityDetailManager=new BX.Cbit.Mc.Core.EntityDetailManager({moduleId:this.moduleId,typeId:this.typeId,entityTypeId:this.entityTypeId,entityId:this.entityId,isNew:this.isNew,pageTitleEditable:!1,enableCategorySelector:!1,cardConfigEditable:this.isAdmin,enableCommunicationControls:!1,enableSectionCreation:this.isAdmin,enableSectionEdit:this.isAdmin,enableFieldsContextMenu:!1,enableSectionEditMode:this.isAdmin,showEmptySections:!1,hideTimelineInCreationPage:!0,isStageFlowActive:!0,reloadOnStageChange:!0})}},{key:"initEvents",value:function(){var t=this;BX.addCustomEvent("onPullEvent",BX.delegate((function(t,e,i){if(t===this.moduleId&&Number(i.itemId)===Number(this.entityId)&&e===this.pullActions.showRejectReasonPopup)this.showRejectReasonPopup()}),this)),BX.addCustomEvent("BX.Crm.EntityEditorSection:onLayout",(function(e){t.insertTypeOfRequestToEditorFrom()}))}},{key:"initButtons",value:function(){var t=this;this.splitBtn=document.querySelector('[data-id="'.concat(this.splitBtnDatasetId,'"]')),this.splitBtn&&this.splitBtn.addEventListener("click",(function(){return t.showSplitAmountPopup()}))}},{key:"showRejectReasonPopup",value:function(){var t=this;this.rejectFormPopup||(this.rejectFormNode=this.createRejectForm(),this.rejectFormPopup=BX.PopupWindowManager.create("reject-request-popup",null,{content:this.rejectFormNode,width:500,closeIcon:!1,titleBar:BX.message("UI_DETAIL_REJECT_REQUEST_REASON"),closeByEsc:!1,overlay:{backgroundColor:"black",opacity:500},buttons:[new BX.PopupWindowButton({text:BX.message("SAVE_TEXT"),className:"ui-btn ui-btn-primary",id:this.submitRejectFormBtnId,events:{click:function(){t.submitRejectForm()}}}),new BX.PopupWindowButton({text:BX.message("EXIT_TEXT"),className:"ui-btn ui-btn-default",events:{click:function(){t.rejectFormPopup.close()}}})]})),this.rejectFormPopup.show()}},{key:"createRejectForm",value:function(){return BX.create("form",{children:[BX.create({tag:"label",props:{className:"ui-ctl ui-ctl-textarea ui-ctl-no-resize"},children:[BX.create({tag:"span",props:{className:"ui-ctl-tag"},text:BX.message("UI_DETAIL_REJECT_REQUEST_REASON")}),BX.create({tag:"textarea",props:{name:"REJECT_REASON",className:"ui-ctl-element"},attrs:{required:!0}})]}),BX.create("input",{props:{type:"hidden",name:"ITEM_ID",value:this.entityId}})]})}},{key:"submitRejectForm",value:function(){var t=this;if(!this.validateForm(this.rejectFormNode))return!1;var e=BX(this.submitRejectFormBtnId);e&&e.classList.add("ui-btn-wait");var i=new FormData(this.rejectFormNode);BX.ajax.runAction("cbit.mc:expense.base.rejectRequest",{sessid:BX.bitrix_sessid(),data:i}).then((function(e){if("success"!==e.status)throw new Error("Something went wrong. Unknown response status - ".response.status);var i,s,n,o,a,r;t.rejectFormPopup.close(),t.rejectFormPopup.destroy(),t.rejectFormPopup=null,t.rejectFormNode=null,null===(i=BX.Cbit)||void 0===i||null===(s=i.Mc)||void 0===s||null===(n=s.Core)||void 0===n||null===(o=n.MainUI)||void 0===o||o.showSuccessPopup(),BX.Crm.EntityEditor.getDefault().refreshLayout(),null!==(a=BX.SidePanel)&&void 0!==a&&null!==(r=a.Instance)&&void 0!==r&&r.opened})).catch((function(t){var i,s,n,o,a,r,l,u=null!==(i=null===(s=t.errors)||void 0===s||null===(n=s[0])||void 0===n?void 0:n.message)&&void 0!==i?i:"Something went wrong. Unknown error";null===(o=BX.Cbit)||void 0===o||null===(a=o.Mc)||void 0===a||null===(r=a.Core)||void 0===r||null===(l=r.MainUI)||void 0===l||l.showErrorPopup(u),e&&e.classList.remove("ui-btn-wait")}))}},{key:"showSplitAmountPopup",value:function(){var t=this;this.splitFormPopup||(this.splitFormNode=this.createSplitForm(),this.splitFormPopup=BX.PopupWindowManager.create("split-request-amount-popup",null,{content:this.splitFormNode,width:500,closeIcon:!1,titleBar:BX.message("UI_DETAIL_SPLIT_POPUP_TITLE"),closeByEsc:!1,overlay:{backgroundColor:"black",opacity:500},buttons:[new BX.PopupWindowButton({text:BX.message("SAVE_TEXT"),className:"ui-btn ui-btn-primary",id:this.submitSplitFormBtnId,events:{click:function(){t.submitSplitForm()}}}),new BX.PopupWindowButton({text:BX.message("EXIT_TEXT"),className:"ui-btn ui-btn-default",events:{click:function(){t.splitFormPopup.close()}}})]})),this.splitFormPopup.show()}},{key:"createSplitForm",value:function(){var t=this,e=BX.create({tag:"input",props:{name:"UF_CRM_".concat(this.typeId,"_AMOUNT_REJECTED"),className:"ui-ctl-element"},attrs:{type:"number",readonly:!0,required:!0}});return BX.create("form",{children:[BX.create({tag:"label",props:{className:"ui-ctl ui-ctl-textbox"},children:[BX.create({tag:"span",props:{className:"ui-ctl-tag"},text:BX.message("UI_DETAIL_SPLIT_FORM_APPROVED_SUM")}),BX.create({tag:"input",props:{name:"OPPORTUNITY",className:"ui-ctl-element"},attrs:{type:"number",required:!0,min:"0",max:"".concat(this.opportunity),autocomplete:"new-password"},events:{input:function(i){Number(i.target.value)>t.opportunity&&(i.target.value=t.opportunity),Number(i.target.value)<0&&(i.target.value=0),e.value=t.opportunity-Number(i.target.value)}}})]}),BX.create({tag:"label",props:{className:"ui-ctl ui-ctl-textbox"},children:[BX.create({tag:"span",props:{className:"ui-ctl-tag"},text:BX.message("UI_DETAIL_SPLIT_FORM_REJECTED_SUM")}),e]}),BX.create({tag:"label",props:{className:"ui-ctl ui-ctl-textarea ui-ctl-no-resize"},children:[BX.create({tag:"span",props:{className:"ui-ctl-tag"},text:BX.message("UI_DETAIL_SPLIT_FORM_REJECT_REASON")}),BX.create({tag:"textarea",props:{name:"UF_CRM_".concat(this.typeId,"_REASON"),className:"ui-ctl-element"},attrs:{required:!0}})]}),BX.create("input",{props:{type:"hidden",name:"ITEM_ID",value:this.entityId}}),BX.create("input",{props:{type:"hidden",name:this.postActionKey,value:this.splitRequestAction}})]})}},{key:"submitSplitForm",value:function(){var t=this;if(!this.validateForm(this.splitFormNode))return!1;var e=BX(this.submitSplitFormBtnId);e&&e.classList.add("ui-btn-wait");var i=new FormData(this.splitFormNode);BX.ajax.runAction("cbit.mc:expense.base.splitRequestAmount",{sessid:BX.bitrix_sessid(),data:i}).then((function(e){if("success"!==e.status)throw new Error("Something went wrong. Unknown response status - ".response.status);var s,n,o,a,r,l;t.splitFormPopup.close(),t.splitFormPopup.destroy(),t.splitFormPopup=null,t.splitFormNode=null,null===(s=BX.Cbit)||void 0===s||null===(n=s.Mc)||void 0===n||null===(o=n.Core)||void 0===o||null===(a=o.MainUI)||void 0===a||a.showSuccessPopup(),BX.Crm.EntityEditor.getDefault().refreshLayout(),t.opportunity=i.get("OPPORTUNITY"),null!==(r=BX.SidePanel)&&void 0!==r&&null!==(l=r.Instance)&&void 0!==l&&l.opened?BX.SidePanel.Instance.reload():window.location.reload()})).catch((function(t){var i,s,n,o,a,r,l,u=null!==(i=null===(s=t.errors)||void 0===s||null===(n=s[0])||void 0===n?void 0:n.message)&&void 0!==i?i:"Something went wrong. Unknown error";null===(o=BX.Cbit)||void 0===o||null===(a=o.Mc)||void 0===a||null===(r=a.Core)||void 0===r||null===(l=r.MainUI)||void 0===l||l.showErrorPopup(u),e&&e.classList.remove("ui-btn-wait")}))}},{key:"validateForm",value:function(t){var e=!0,i=t.querySelectorAll("input, select, textarea");return i.length&&i.forEach((function(t){var i=t.closest(".ui-ctl");t.hasAttribute("required")&&!t.value?(i&&i.classList.add("ui-ctl-danger"),e=!1):i&&i.classList.remove("ui-ctl-danger")})),e}},{key:"insertTypeOfRequestToEditorFrom",value:function(){if(!BX(this.typeOfRequestNodeId)){var t=document.querySelector('[data-cid="general"] .ui-entity-editor-section-content');t&&t.prepend(BX.create("div",{props:{className:"ui-entity-editor-content-block",id:this.typeOfRequestNodeId},children:[BX.create("div",{props:{className:"ui-entity-editor-block-title"},text:BX.message("TYPE_OF_REQUEST_BLOCK_TITLE")}),BX.create("div",{props:{className:"ui-entity-editor-content-block"},children:[BX.create("div",{props:{className:"ui-entity-editor-content-block-text"},html:"<b>".concat(this.typeOfRequest,"</b>")})]})]}))}}}]),t}();BX.ready((function(){try{BX.Cbit.Mc.Expense.UiDetail=new i(e.Extension.getSettings("cbit.mc.expense.ui-detail"))}catch(t){console.log("Expense UiDetail error",t)}}))}(this.BX.Cbit.Mc.Expense=this.BX.Cbit.Mc.Expense||{},BX);
//# sourceMappingURL=index.bundle.js.map
