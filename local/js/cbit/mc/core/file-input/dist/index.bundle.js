this.BX=this.BX||{},this.BX.Cbit=this.BX.Cbit||{},this.BX.Cbit.Mc=this.BX.Cbit.Mc||{},function(e,i){"use strict";var t=function(){function e(){babelHelpers.classCallCheck(this,e)}return babelHelpers.createClass(e,[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.allowedExt=[],this.elementId=e.ENTITY_VALUE_ID,this.maxFileSize=this.getMaxFileSizeFromSettings(e),this.fieldId=e.ID,this.fieldName=e.FIELD_NAME,this.isMultiple="Y"===e.MULTIPLE,this.container=BX(e.CONTAINER_ID),this.valuesBlock=BX(e.VALUES_BLOCK_ID),this.fileInput=BX(e.FILE_INPUT_ID),this.fillAllowedExtensions(e.SETTINGS),this.renderCurrentValue(e.VALUE_ITEMS),this.initEvents()}},{key:"renderCurrentValue",value:function(e){if("object"===babelHelpers.typeof(e))for(var i in e)this.appendFileToCurrentValue(e[i])}},{key:"fillAllowedExtensions",value:function(e){if("object"===babelHelpers.typeof(null==e?void 0:e.EXTENSIONS))for(var i in e.EXTENSIONS)!0===e.EXTENSIONS[i]&&this.allowedExt.push(i)}},{key:"initEvents",value:function(){var e=this;this.fileInput&&this.fileInput.addEventListener("change",(function(){return e.onFileAdd()}))}},{key:"onFileAdd",value:function(){var e=this;if(this.checkFiles(this.fileInput.files)){var i=new FormData;i.append("USER_FIELD_ID",this.fieldId),i.append("FILE",this.fileInput.files[0]);var t=this.fileInput.closest("label");t&&t.classList.add("loading"),BX.ajax.runAction("cbit.mc:core.base.uploadFile",{sessid:BX.bitrix_sessid(),data:i}).then((function(i){if("success"!==i.status)throw new Error("Something went wrong. Unknown response status - ".response.status);var l,n,s,a;if(!i.data.ID)throw new Error("File id not found in response");e.appendFileToCurrentValue(i.data),null===(l=BX.Crm)||void 0===l||null===(n=l.EntityEditor)||void 0===n||null===(s=n.getDefault())||void 0===s||null===(a=s.getControlById(e.fieldName))||void 0===a||a.markAsChanged(),t&&t.classList.remove("loading"),e.fileInput.value=""})).catch((function(e){var i,l,n,s,a,o,r,u=null!==(i=null===(l=e.errors)||void 0===l||null===(n=l[0])||void 0===n?void 0:n.message)&&void 0!==i?i:"Something went wrong. Unknown error";null===(s=BX.Cbit)||void 0===s||null===(a=s.Mc)||void 0===a||null===(o=a.Core)||void 0===o||null===(r=o.MainUI)||void 0===r||r.showErrorPopup(u),t&&t.classList.remove("loading")}))}}},{key:"onFileDelete",value:function(e){if(!Number(e)>0){var i,t,l,n;null===(i=BX.Cbit)||void 0===i||null===(t=i.Mc)||void 0===t||null===(l=t.Core)||void 0===l||null===(n=l.MainUI)||void 0===n||n.showErrorPopup("File id can not be empty")}else{var s=this.isMultiple?"".concat(this.fieldName,"_add_").concat(e):"".concat(this.fieldName,"_add"),a=BX(s);if(a){var o,r,u,d,c=a.closest(".webform-field-item-wrap");c?c.remove():a.remove(),null===(o=BX.Crm)||void 0===o||null===(r=o.EntityEditor)||void 0===r||null===(u=r.getDefault())||void 0===u||null===(d=u.getControlById(this.fieldName))||void 0===d||d.markAsChanged(),this.fileInput.value=""}}}},{key:"checkFiles",value:function(e){for(var i=!0,t=0;t<e.length;t++){e[t].size>this.maxFileSize&&(BX.Cbit.Mc.Core.MainUI.showErrorPopup(BX.message("MAX_FILE_SIZE_ERROR")),i=!1);var l=this.getExtFromFileName(e[t].name);this.allowedExt.includes(l)||(BX.Cbit.Mc.Core.MainUI.showErrorPopup(BX.message("FILE_EXT_ERROR")),i=!1)}return i}},{key:"getMaxFileSizeFromSettings",value:function(e){var i,t=10485760;return null!==(i=e.SETTINGS)&&void 0!==i&&i.MAX_ALLOWED_SIZE&&!isNaN(e.SETTINGS.MAX_ALLOWED_SIZE)&&(t=Number(e.SETTINGS.MAX_ALLOWED_SIZE)),t}},{key:"getExtFromFileName",value:function(e){var i="",t=(e=String(e)).split(".");return t.length>1&&(i=t[t.length-1]),i}},{key:"appendFileToCurrentValue",value:function(e){var i=this,t=Number(e.FILE_SIZE)>=1024?0:2,l=(Number(e.FILE_SIZE)/1024).toFixed(t),n=this.isMultiple?"".concat(this.fieldName,"_add_").concat(e.ID):"".concat(this.fieldName,"_add"),s=BX(n);if(s)s.value=e.ID;else{var a=BX.create("div",{props:{className:"webform-field-item-wrap"},children:[BX.create("a",{props:{className:"upload-file-name"},attrs:{href:e.SRC,target:"_blank"},text:e.ORIGINAL_NAME}),BX.create("span",{props:{className:"upload-file-size"},text:"".concat(l,"kb")}),BX.create("span",{props:{className:"file-delete"},dataset:{id:e.ID},text:"delete",events:{click:function(){return i.onFileDelete(e.ID)}}}),BX.create("input",{attrs:{id:n,type:"hidden",name:this.isMultiple?"".concat(this.fieldName,"[]"):this.fieldName},props:{value:e.ID}})]});this.valuesBlock&&this.valuesBlock.append(a)}}}]),e}();BX.ready((function(){try{BX.Cbit.Mc.Core.FileInput=new t(i.Extension.getSettings("cbit.mc.expense.file-input"))}catch(e){console.log("Extension FileInput error",e)}}))}(this.BX.Cbit.Mc.Core=this.BX.Cbit.Mc.Core||{},BX);
//# sourceMappingURL=index.bundle.js.map
